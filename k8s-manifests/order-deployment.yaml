apiVersion: apps/v1
kind: Deployment
metadata:
  name: order-service
  namespace: ecommerce
spec:
  replicas: 1
  selector:
    matchLabels:
      app: order-service
  template:
    metadata:
      labels:
        app: order-service
    spec:
      serviceAccountName: adot-collector-service-account
      automountServiceAccountToken: true
      containers:
        - name: order-service
          image: docker.io/sukhman78/ecommerce-deployment:order-service
          imagePullPolicy: Always
          ports:
            - containerPort: 8084
          env:
            - name: SPRING_PROFILES_ACTIVE
              value: kubernetes
            - name: EUREKA_CLIENT_SERVICEURL_DEFAULTZONE
              value: http://discovery-service:8761/eureka
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://postgres:5432/ecommercedb
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_USER
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret
                  key: POSTGRES_PASSWORD
            # CRITICAL: Java Agent Configuration
            - name: JAVA_TOOL_OPTIONS
              value: >
                -javaagent:/otel/opentelemetry-javaagent.jar
                -Dotel.service.name=cart-service
                -Dotel.traces.exporter=otlp
                -Dotel.metrics.exporter=none
                -Dotel.logs.exporter=none
                -Dotel.exporter.otlp.endpoint=http://adot-collector.ecommerce:4318
                -Dotel.exporter.otlp.protocol=http/protobuf
                -Dotel.resource.attributes=service.name=cart-service,k8s.namespace=ecommerce,k8s.deployment.name=cart-service
                -Dotel.instrumentation.log4j.enabled=false
                -Dotel.instrumentation.logback-appender.enabled=false
                -Dotel.traces.sampler=always_on
                -Dotel.javaagent.debug=false
          volumeMounts:
            - name: opentelemetry-javaagent
              mountPath: /otel
              readOnly: true
      initContainers:
        # Download OpenTelemetry Java Agent
        - name: download-javaagent
          image: curlimages/curl:latest
          command: 
            - sh
            - -c
            - |
              echo "Downloading OpenTelemetry Java Agent..."
              curl -L https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases/latest/download/opentelemetry-javaagent.jar \
                -o /otel/opentelemetry-javaagent.jar
              echo "Download complete. File size:"
              ls -lh /otel/opentelemetry-javaagent.jar
          volumeMounts:
            - name: opentelemetry-javaagent
              mountPath: /otel
      volumes:
        - name: opentelemetry-javaagent
          emptyDir: {}
